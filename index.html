<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Photo Roulette – Telegram Mini App</title>

<style>
:root{
  --bg:#f3f3f0; --fg:#0e1116; --muted:#6b7280;
  --card-bg:#e7e7ea; --card-border:rgba(255,255,255,.9);
  --overlay:rgba(0,0,0,.58); --pointer:rgba(0,0,0,.55);
  --shadow-btn:0 2px 8px rgba(0,0,0,.08);
  --shadow-card:0 6px 14px rgba(0,0,0,.10);

  /* кнопки по умолчанию (светлая тема) */
  --btn-bg:#1a1d21; --btn-fg:#ffffff;
  --btn-bg-disabled:#3b3f45; --btn-fg-disabled:#cfd3da;

  /* переменные превью — будут переопределяться из JS */
  --thumb:64px;            /* размер квадрата превью */
  --preview-cols:4;        /* количество колонок (макс 4) */
}
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0b0c0f; --fg:#e7eaf0; --muted:#a8b0ba;
    --card-bg:#15181c; --card-border:rgba(255,255,255,.14);
    --overlay:rgba(0,0,0,.65); --pointer:rgba(255,255,255,.7);
    --shadow-btn:0 2px 10px rgba(0,0,0,.35);
    --shadow-card:0 6px 16px rgba(0,0,0,.38);

    /* кнопки для тёмной темы */
    --btn-bg:#f2f3f5; --btn-fg:#0b0c0f;
    --btn-bg-disabled:#d6d9de; --btn-fg-disabled:#6c7077;
  }
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
  font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

.screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100svh;padding:16px}
.hidden{display:none!important}

/* Кнопки */
.btn{
  border:none;border-radius:22px;min-width:260px;padding:14px 18px;
  font:700 16px/1.1 inherit;cursor:pointer;
  color:var(--btn-fg);background:var(--btn-bg);box-shadow:var(--shadow-btn);
  transition:transform .06s ease, filter .15s ease, opacity .15s ease
}
.btn:active{transform:translateY(1px)}
.btn:disabled{background:var(--btn-bg-disabled);color:var(--btn-fg-disabled);cursor:not-allowed;box-shadow:none;opacity:.9}
.btn.small{min-width:140px}
#btn-load{min-width:175px;padding:10px 14px;font-size:14px}
#btn-go{margin-top:20px}

.counter{font-weight:700;margin-bottom:12px}
.hint{color:var(--muted);margin-top:18px}

/* ====== ПРЕДПРОСМОТР ====== */
.preview{width:100%;padding:0 10%;margin-top:16px}
.preview-grid{
  display:grid;
  grid-template-columns: repeat(var(--preview-cols), minmax(0,1fr));
  gap:12px;
  justify-items:center;
}
.preview-item{
  width:var(--thumb); height:var(--thumb); aspect-ratio:1/1;
  border-radius:14px; overflow:hidden;
  background:var(--card-bg); border:2px solid var(--card-border);
  box-shadow:var(--shadow-card); display:flex;align-items:center;justify-content:center;
}
.preview-item .img-wrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center}
.preview-item img{max-width:100%;max-height:100%;object-fit:contain;display:block}

/* ====== Барабан ====== */
.drum-wrap{position:relative;width:100%;height:420px;display:flex;align-items:center;justify-content:center;overflow:hidden;contain:paint}
.drum{display:flex;align-items:center;gap:18px;will-change:transform;transform:translate3d(0,0,0)}
.drum-wrap.spinning .card{box-shadow:none}

/* Карточки в барабане */
.card{
  width:256px;height:256px;aspect-ratio:1/1;border-radius:24px;overflow:hidden;
  background:var(--card-bg);border:2px solid var(--card-border);box-shadow:var(--shadow-card)
}
.card .img-wrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center}
.card img{max-width:100%;max-height:100%;object-fit:contain;display:block}

/* Индикатор */
.center-indicator{
  position:absolute;left:50%;bottom:18px;transform:translateX(-50%);
  width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;
  border-bottom:14px solid var(--pointer);filter:drop-shadow(0 2px 4px rgba(0,0,0,.25));pointer-events:none
}

/* Попап победителя */
.overlay{position:fixed;inset:0;background:var(--overlay);display:flex;align-items:center;justify-content:center}
.popup{display:flex;flex-direction:column;align-items:center;gap:16px}
.winnerBox{
  width:min(90vw,512px);height:min(90vw,512px);aspect-ratio:1/1;border-radius:26px;border:3px solid #fff;
  overflow:hidden;display:flex;align-items:center;justify-content:center;
  animation:whiteGlow 2.4s ease-in-out infinite alternate, pulse 3.8s ease-in-out .6s infinite;will-change:transform,box-shadow
}
.winnerBox.pop{animation:popInGlow 420ms cubic-bezier(.17,.94,.35,1.12) forwards, pulse 3.8s ease-in-out .42s infinite}
.winner{max-width:100%;max-height:100%;object-fit:contain;display:block}

/* Анимации */
@keyframes popInGlow{
  0%{transform:scale(.85);opacity:0;box-shadow:0 0 0 rgba(255,255,255,0)}
  60%{transform:scale(1.05);opacity:1;box-shadow:0 0 90px rgba(255,255,255,.3)}
  100%{transform:scale(1);opacity:1;box-shadow:0 0 160px rgba(255,255,255,.35)}
}
@keyframes whiteGlow{
  from{box-shadow:0 0 40px rgba(255,255,255,.45),0 0 80px rgba(255,255,255,.35),0 0 120px rgba(255,255,255,.25)}
  to{box-shadow:0 0 55px rgba(255,255,255,.65),0 0 110px rgba(255,255,255,.45),0 0 160px rgba(255,255,255,.35)}
}
@keyframes pulse{0%{transform:scale(.985)}50%{transform:scale(1.015)}100%{transform:scale(.985)}}

/* Адаптив */
@media (max-width:1400px){.card{width:224px;height:224px}#btn-go{min-width:420px;padding:22px 26px;font-size:22px}}
@media (max-width:1000px){.card{width:200px;height:200px}#btn-go{min-width:340px;padding:20px 22px;font-size:20px}}
@media (max-width:700px){.card{width:180px;height:180px}#btn-go{min-width:280px;padding:18px 20px;font-size:18px}#btn-load{min-width:150px;font-size:13px}}
@media (max-width:480px){.card{width:160px;height:160px}#btn-go{min-width:240px;padding:16px 18px;font-size:16px}#btn-load{min-width:130px;font-size:12px;padding:8px 10px}}
</style>
</head>
<body>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<div class="screen" id="screen-start">
  <div class="counter" id="counter" hidden>Загружено <span id="count">0</span> фотографий</div>
  <input id="file" type="file" accept="image/*" multiple hidden>

  <!-- БЛОК ПРЕДПРОСМОТРА -->
  <section id="preview" class="preview hidden">
    <div id="preview-grid" class="preview-grid"></div>
  </section>

  <button id="btn-load" class="btn">Загрузить фотографии</button>
  <button id="btn-go" class="btn" disabled>Let's go</button>
  <div class="hint">Максимум 8 фото</div>
</div>

<section class="screen hidden" id="screen-spin">
  <div class="drum-wrap" id="drumWrap">
    <div id="drum" class="drum"></div>
    <div class="center-indicator"></div>
  </div>
</section>

<div id="overlay" class="overlay hidden">
  <div class="popup">
    <div id="winnerBox" class="winnerBox"><img id="winner" class="winner" alt=""></div>
    <button id="btn-done" class="btn small">Готово</button>
  </div>
</div>

<script>
/* Telegram WebApp */
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); tg.disableVerticalSwipes?.(); }

/* State & helpers */
const MAX=8, GAP=18;
let images=[];
const $=s=>document.querySelector(s);
const btnLoad=$('#btn-load'), btnGo=$('#btn-go'), file=$('#file');
const counter=$('#counter'), countEl=$('#count');
const preview=$('#preview'), previewGrid=$('#preview-grid');
const screenStart=$('#screen-start'), screenSpin=$('#screen-spin');
const drum=$('#drum'), drumWrap=$('#drumWrap');
const overlay=$('#overlay'), btnDone=$('#btn-done');
const winner=$('#winner'), winnerBox=$('#winnerBox');

/* Загрузка фото */
btnLoad.addEventListener('click',()=>file.click(),{passive:true});
file.addEventListener('change',(e)=>{
  const files=Array.from(e.target.files||[]).slice(0,MAX);
  images=files.map(f=>({src:URL.createObjectURL(f)}));
  countEl.textContent=images.length;
  counter.hidden=images.length===0;
  btnGo.disabled=images.length===0;

  buildPreview();               // ← рисуем предпросмотр
},{passive:true});

/* Построить превью-сетку */
function buildPreview(){
  previewGrid.innerHTML='';
  if(!images.length){ preview.classList.add('hidden'); return; }

  // размер и колонки: ≤4 → 2x128px, >4 → 4x64px
  const small = images.length > 4;
  const cols  = small ? 4 : 2;
  const size  = small ? 64 : 128;

  document.documentElement.style.setProperty('--preview-cols', cols);
  document.documentElement.style.setProperty('--thumb', size+'px');

  const frag=document.createDocumentFragment();
  for(const img of images){
    const item=document.createElement('div'); item.className='preview-item';
    const wrap=document.createElement('div'); wrap.className='img-wrap';
    const el=document.createElement('img'); el.src=img.src; el.loading='eager'; el.decoding='async';
    wrap.appendChild(el); item.appendChild(wrap); frag.appendChild(item);
  }
  previewGrid.appendChild(frag);
  preview.classList.remove('hidden');
}

/* Запуск рулетки — длинная лента (~120 карточек) */
btnGo.addEventListener('click', async ()=>{
  if(!images.length) return;

  // длинная полоса
  drum.innerHTML='';
  const TARGET_ITEMS = 120;
  const reps = Math.ceil(TARGET_ITEMS / images.length) + 4;
  const frag=document.createDocumentFragment();
  for (let r=0;r<reps;r++){
    for (const img of images){
      const card=document.createElement('div'); card.className='card';
      const wrap=document.createElement('div'); wrap.className='img-wrap';
      const el=document.createElement('img'); el.src=img.src; el.loading='eager'; el.decoding='async';
      wrap.appendChild(el); card.appendChild(wrap); frag.appendChild(card);
    }
  }
  drum.appendChild(frag);

  screenStart.classList.add('hidden');
  screenSpin.classList.remove('hidden');
  await new Promise(requestAnimationFrame);

  // размеры
  const first=drum.querySelector('.card');
  const itemSize=first.getBoundingClientRect().width;
  const gap=parseFloat(getComputedStyle(drum).gap)||GAP;
  const step=itemSize+gap;

  const centerOffset = ()=> (drumWrap.clientWidth/2)-(itemSize/2);
  let cOff=centerOffset();
  const onResize=()=>{ cOff=centerOffset(); };
  window.addEventListener('resize', onResize, {passive:true});

  drumWrap.classList.add('spinning');

  const plannedIndex = Math.floor(Math.random()*images.length);
  /* Настрой для более «видимого» старта:
     уменьшай loops (например, 3) и увеличивай duration (например, 5000+) */
  const loops = 3;  // ← можно менять
  const duration = 5200 + Math.floor(Math.random()*900); // ← можно менять

  const totalDistance = loops*images.length*step + plannedIndex*step;
  const start = performance.now();

  const indexFromX = x => Math.round((x - itemSize/2) / step) % images.length;

  function frame(now){
    const t=Math.min(1,(now-start)/duration);
    const eased = 1 - Math.pow(1-t,3);
    const x = eased * totalDistance;

    drum.style.transform = `translate3d(${cOff - x}px,0,0)`;

    if(t<1) requestAnimationFrame(frame);
    else{
      window.removeEventListener('resize', onResize);
      drumWrap.classList.remove('spinning');

      // победитель — ближайший к центру
      const wrapRect=drumWrap.getBoundingClientRect();
      const centerX=wrapRect.left+wrapRect.width/2;
      let best=0,bestDist=1e9, nodes=drum.children;
      for(let i=0;i<nodes.length;i++){
        const r=nodes[i].getBoundingClientRect();
        const dx=Math.abs((r.left+r.width/2)-centerX);
        if(dx<bestDist){bestDist=dx;best=i;}
      }
      const finalIndex = (best % images.length + images.length) % images.length;
      showWinner(images[finalIndex].src);
    }
  }
  requestAnimationFrame(frame);
},{passive:true});

/* Попап победителя */
function showWinner(src){
  winner.src=src;
  winnerBox.classList.add('pop');
  const onEnd=e=>{ if(e.animationName==='popInGlow'){ winnerBox.classList.remove('pop'); winnerBox.removeEventListener('animationend',onEnd);} };
  winnerBox.addEventListener('animationend',onEnd);
  overlay.classList.remove('hidden');
}

/* Сброс в начало */
btnDone.addEventListener('click', ()=>{
  images.forEach(i=>URL.revokeObjectURL(i.src));
  images=[]; drum.innerHTML=''; overlay.classList.add('hidden');
  counter.hidden=true; btnGo.disabled=true;
  previewGrid.innerHTML=''; preview.classList.add('hidden');
  screenSpin.classList.add('hidden'); screenStart.classList.remove('hidden');
},{passive:true});

/* reduced motion */
if (window.matchMedia('(prefers-reduced-motion: reduce)').matches){
  const css=document.createElement('style');
  css.textContent='.winnerBox{animation:none}.winnerBox.pop{animation:popInGlow 360ms ease-out forwards}';
  document.head.appendChild(css);
}
</script>
</body>
</html>
