<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Photo Roulette – Telegram Mini App</title>

<style>
:root{
  --bg:#f3f3f0; --fg:#0e1116; --muted:#6b7280;
  --card-bg:#e7e7ea; --card-border:rgba(255,255,255,.9);
  --overlay:rgba(0,0,0,.58); --pointer:rgba(0,0,0,.55);
  --shadow-btn:0 2px 8px rgba(0,0,0,.08);
  --shadow-card:0 4px 10px rgba(0,0,0,.10);

  --btn-bg:#1a1d21; --btn-fg:#ffffff;
  --btn-bg-disabled:#3b3f45; --btn-fg-disabled:#cfd3da;

  --thumb:128px;
  --preview-cols:3;
}
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0b0c0f; --fg:#e7eaf0; --muted:#a8b0ba;
    --card-bg:#15181c; --card-border:rgba(255,255,255,.14);
    --overlay:rgba(0,0,0,.65); --pointer:rgba(255,255,255,.7);
    --shadow-btn:0 2px 10px rgba(0,0,0,.35);
    --shadow-card:0 4px 12px rgba(0,0,0,.35);

    --btn-bg:#f2f3f5; --btn-fg:#0b0c0f;
    --btn-bg-disabled:#d6d9de; --btn-fg-disabled:#6c7077;
  }
}

*{box-sizing:border-box}
html,body{
  height:100%;margin:0;background:var(--bg);color:var(--fg);
  font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
.screen{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:100svh;padding:16px;
}
.hidden{display:none!important}

/* Кнопки */
.btn{
  border:none;border-radius:22px;min-width:260px;padding:14px 18px;
  font:700 16px/1.1 inherit;cursor:pointer;
  color:var(--btn-fg);background:var(--btn-bg);box-shadow:var(--shadow-btn);
  transition:transform .06s ease,filter .15s ease,opacity .15s ease;
}
.btn:active{transform:translateY(1px)}
.btn:disabled{
  background:var(--btn-bg-disabled);
  color:var(--btn-fg-disabled);
  cursor:not-allowed;box-shadow:none;opacity:.9;
}
.btn.small{min-width:140px}
#btn-load{min-width:175px;padding:10px 14px;font-size:14px}
#btn-go{margin-top:20px}

.counter{font-weight:700;margin-bottom:12px}
.hint{color:var(--muted);margin-top:18px}

/* ====== ПРЕДПРОСМОТР ====== */
.preview{
  width:100%;
  padding:0 10%;
  margin-top:24px;
}
.preview-grid{
  display:grid;
  grid-template-columns:repeat(var(--preview-cols),minmax(0,1fr));
  gap:12px;
  justify-items:center;
}
.preview-item{
  width:var(--thumb);height:var(--thumb);
  border-radius:14px;overflow:hidden;
  background:var(--card-bg);border:2px solid var(--card-border);
  box-shadow:var(--shadow-card);display:flex;align-items:center;justify-content:center;
}
.preview-item img{max-width:100%;max-height:100%;object-fit:contain;display:block}

/* ====== Барабан (УМЕНЬШЕННЫЕ КАРТОЧКИ) ====== */
.drum-wrap{
  position:relative;width:100%;height:300px;
  display:flex;align-items:center;justify-content:center;overflow:hidden;contain:paint;
}
.drum{
  display:flex;align-items:center;gap:12px;will-change:transform;
}

/* КАРТОЧКИ УМЕНЬШЕНЫ С 128px ДО 86px */
.card{
  width:86px; height:86px;
  border-radius:14px;overflow:hidden;
  background:var(--card-bg);border:2px solid var(--card-border);
  box-shadow:var(--shadow-card);
}
.card img{max-width:100%;max-height:100%;object-fit:contain;display:block}

/* Индикатор */
.center-indicator{
  position:absolute;left:50%;bottom:14px;transform:translateX(-50%);
  width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;
  border-bottom:12px solid var(--pointer);
}

/* ====== ПОБЕДИТЕЛЬ (УМЕНЬШЕН С 192px ДО 96px) ====== */
.overlay{
  position:fixed;inset:0;background:var(--overlay);
}
.popup{
  position:fixed;left:50%;transform:translate(-50%,-50%);
  display:flex;flex-direction:column;align-items:center;gap:12px;
}

.winnerBox{
  width:96px; height:96px; /* ↓ уменьшено ровно в 2 раза */
  border-radius:14px;border:3px solid #fff;
  overflow:hidden;display:flex;align-items:center;justify-content:center;
}

.winner{max-width:100%;max-height:100%;object-fit:contain;display:block}

.winnerBox.pop{
  animation:popInSimple 200ms ease-out both;
}
@keyframes popInSimple{
  from{transform:scale(.9);opacity:0}
  to{transform:scale(1);opacity:1}
}

</style>
</head>
<body>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<div class="screen" id="screen-start">
  <div class="counter" id="counter" hidden>Загружено <span id="count">0</span> фотографий</div>
  <input id="file" type="file" accept="image/*" multiple hidden>

  <button id="btn-load" class="btn">Загрузить фотографии</button>

  <section id="preview" class="preview hidden">
    <div id="preview-grid" class="preview-grid"></div>
  </section>

  <button id="btn-go" class="btn" disabled>Let's go</button>
  <div class="hint">Максимум 8 фото</div>
</div>

<section class="screen hidden" id="screen-spin">
  <div class="drum-wrap" id="drumWrap">
    <div id="drum" class="drum"></div>
    <div class="center-indicator"></div>
  </div>
</section>

<div id="overlay" class="overlay hidden">
  <div id="popup" class="popup">
    <div id="winnerBox" class="winnerBox"><img id="winner" class="winner" alt=""></div>
    <button id="btn-done" class="btn small">Готово</button>
  </div>
</div>

<script>
const tg=window.Telegram?.WebApp;
if(tg){tg.ready();tg.expand();tg.disableVerticalSwipes?.();}

const MAX=8, GAP=12;
let images=[];

const $=s=>document.querySelector(s);
const btnLoad=$('#btn-load'), btnGo=$('#btn-go'),
      file=$('#file'), counter=$('#counter'),
      countEl=$('#count'), preview=$('#preview'),
      previewGrid=$('#preview-grid'),
      screenStart=$('#screen-start'), screenSpin=$('#screen-spin'),
      drum=$('#drum'), drumWrap=$('#drumWrap'),
      overlay=$('#overlay'), popup=$('#popup'),
      btnDone=$('#btn-done'),
      winner=$('#winner'), winnerBox=$('#winnerBox');

/* ===============================
      ЗАГРУЗКА ФОТО
=============================== */
btnLoad.addEventListener('click',()=>file.click());
file.addEventListener('change',e=>{
  const files=Array.from(e.target.files||[]).slice(0,MAX);
  images=files.map(f=>({src:URL.createObjectURL(f)}));

  countEl.textContent=images.length;
  counter.hidden=!images.length;
  btnGo.disabled=!images.length;

  buildPreview();
});

/* ===============================
      ПРЕДПРОСМОТР
=============================== */
function computePreviewCols(n){
  if(n<=2)return n;
  if(n===3)return 3;
  if(n===4)return 2;
  if(n===5||n===6)return 3;
  return 4;
}

function buildPreview(){
  previewGrid.innerHTML='';
  if(!images.length){preview.classList.add('hidden');return;}

  const n=images.length;
  const cols=computePreviewCols(n);
  const size=(cols===4)?64:128;

  document.documentElement.style.setProperty('--preview-cols',cols);
  document.documentElement.style.setProperty('--thumb',size+'px');

  for(const img of images){
    const box=document.createElement('div');
    box.className='preview-item';
    const im=document.createElement('img');
    im.src=img.src;
    box.appendChild(im);
    previewGrid.appendChild(box);
  }

  preview.classList.remove('hidden');
}

/* ===============================
      РУЛЕТКА
=============================== */
btnGo.addEventListener('click',async()=>{
  if(!images.length)return;

  /* создаём длинную ленту */
  drum.innerHTML='';
  const TARGET=120;
  const reps=Math.ceil(TARGET/images.length)+4;

  for(let r=0;r<reps;r++){
    for(const img of images){
      const card=document.createElement('div');
      card.className='card';
      const el=document.createElement('img');
      el.src=img.src;
      card.appendChild(el);
      drum.appendChild(card);
    }
  }

  screenStart.classList.add('hidden');
  screenSpin.classList.remove('hidden');

  await new Promise(r=>requestAnimationFrame(r));

  const first=drum.querySelector('.card');
  const itemSize=first.getBoundingClientRect().width; /* теперь 86px */
  const gap=parseFloat(getComputedStyle(drum).gap)||GAP;
  const step=itemSize+gap;

  const centerOffset=()=>drumWrap.clientWidth/2-itemSize/2;
  let cOff=centerOffset();

  const onResize=()=>{cOff=centerOffset(); if(!overlay.classList.contains('hidden')) positionPopup();};
  window.addEventListener('resize',onResize);

  const loops=3;
  const duration=Math.max(2000,5200+Math.random()*900-800);
  const planned=Math.floor(Math.random()*images.length);
  const total=loops*images.length*step+planned*step;

  const start=performance.now();
  function frame(now){
    const t=Math.min(1,(now-start)/duration);
    const eased=1-Math.pow(1-t,3);
    const x=eased*total;
    drum.style.transform=`translate3d(${cOff-x}px,0,0)`;

    if(t<1)requestAnimationFrame(frame); else {
      window.removeEventListener('resize',onResize);

      const wrapRect=drumWrap.getBoundingClientRect();
      const centerX=wrapRect.left+wrapRect.width/2;
      let best=0,bestDist=1e9;
      const nodes=drum.children;

      for(let i=0;i<nodes.length;i++){
        const r=nodes[i].getBoundingClientRect();
        const dx=Math.abs((r.left+r.width/2)-centerX);
        if(dx<bestDist){bestDist=dx;best=i;}
      }

      const finalIndex=(best%images.length+images.length)%images.length;
      showWinner(images[finalIndex].src);
    }
  }
  requestAnimationFrame(frame);
});

/* ===============================
    ПОЗИЦИОНИРОВАНИЕ ПОБЕДИТЕЛЯ
=============================== */
function positionPopup(){
  const rect=drumWrap.getBoundingClientRect();
  const centerY=rect.top+rect.height/2+32; /* смещение вниз */
  popup.style.top=centerY+'px';
}

function showWinner(src){
  winner.src=src;
  positionPopup();

  winnerBox.classList.remove('pop');
  void winnerBox.offsetWidth;
  winnerBox.classList.add('pop');

  overlay.classList.remove('hidden');

  const onResize=()=>positionPopup();
  window.addEventListener('resize',onResize);

  btnDone.addEventListener('click',()=>window.removeEventListener('resize',onResize),{once:true});
}

/* СБРОС */
btnDone.addEventListener('click',()=>{
  images.forEach(i=>URL.revokeObjectURL(i.src));
  images=[];
  drum.innerHTML='';
  overlay.classList.add('hidden');
  counter.hidden=true;
  btnGo.disabled=true;
  previewGrid.innerHTML='';
  preview.classList.add('hidden');
  screenSpin.classList.add('hidden');
  screenStart.classList.remove('hidden');
});
</script>
</body>
</html>